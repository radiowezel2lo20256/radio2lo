<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Harmonogram Radiowƒôz≈Ça</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background:#f8f9fa; padding: 20px; }
    .table-card { 
      background:white; padding:20px; border-radius:12px; 
      box-shadow:0 4px 16px rgba(0,0,0,0.1); 
      max-width:900px; margin:40px auto;
    }
    table { width:100%; border-collapse:collapse; text-align:center; }
    th, td { border:1px solid #ccc; padding:10px; vertical-align:middle; }
    th { background:#8865AD; color:white; font-weight:bold; }
    caption { caption-side:top; font-weight:bold; margin-bottom:10px; }
    button { margin:10px; }
  </style>
</head>
<body>
  <div class="text-center">
    <h1>Harmonogram Radiowƒôz≈Ça</h1>
  </div>

  <div id="result" class="table-card text-center">
    <p class="text-muted">Trwa ≈Çadowanie danych z arkusza...</p>
  </div>

  <div class="text-center">
    <button id="regenBtn" class="btn btn-primary" disabled>üé≤ Generuj ponownie</button>
    <button id="saveBtn" class="btn btn-success" disabled>üíæ Zapisz jako PNG</button>
  </div>

  <script>
    // üîß KONFIGURACJA
    const API_KEY = "AIzaSyCVidQq2T5RZzSXFlrJ9QUOXo3_TduwcCg";
    const SPREADSHEET_ID = "1r-wkjITbyEBckGnXN1rzr4_MI-8U3PwiSoh8gntTi1k";
    const RANGE = "A:B"; // kolumny: Klasa, Osoby

    const DAYS = ["Poniedzia≈Çek", "Wtorek", "≈öroda", "Czwartek", "PiƒÖtek"];
    let entries = []; // dane z arkusza

    // üóìÔ∏è Najbli≈ºszy poniedzia≈Çek
    function getNextMonday() {
      const now = new Date();
      const day = now.getDay(); // 0=niedz., 1=pon.
      const diff = (day === 0 ? 1 : 8 - day);
      const monday = new Date(now);
      monday.setDate(now.getDate() + diff);
      return monday;
    }

    // üóìÔ∏è Daty Pn‚ÄìPt
    function getWeekDates() {
      const monday = getNextMonday();
      const days = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        const formatted = d.toLocaleDateString("pl-PL", { day: "2-digit", month: "2-digit" });
        days.push({ label: DAYS[i], date: formatted });
      }
      return days;
    }

    // üì• Pobieranie danych z Google Sheets
    async function loadSheetData() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Nie uda≈Ço siƒô pobraƒá danych z Google Sheets.");
      const data = await res.json();
      return data.values || [];
    }

    // üìã Parsowanie danych
    function parsePeople(rows) {
      const data = rows.slice(1); // pomijamy nag≈Ç√≥wek
      const parsed = [];
      for (const [klasa, osobyRaw] of data) {
        if (!klasa && !osobyRaw) continue;
        const names = (osobyRaw || "")
          .split(/[,;]+/)
          .map(x => x.trim())
          .filter(Boolean);
        if (names.length > 0) parsed.push({ klasa: klasa.trim(), osoby: names });
      }
      return parsed;
    }

    // üé≤ Generowanie harmonogramu
    function generateSchedule(entries) {
      const available = [...entries];
      const weekDays = getWeekDates();
      const schedule = {};

      for (const { label, date } of weekDays) {
        if (available.length === 0) {
          schedule[label] = { date, osoby: [] };
          continue;
        }

        // losujemy wiersz z tabeli
        const idx = Math.floor(Math.random() * available.length);
        const row = available.splice(idx, 1)[0];
        let osoby = row.osoby;

        // je≈õli tylko jedna osoba ‚Äî tylko ona
        if (osoby.length === 1) {
          schedule[label] = { date, osoby: [{ name: osoby[0], klasa: row.klasa }] };
        } else {
          // je≈õli wiƒôcej ‚Äî wybierz maks. 2 losowe
          const selected = osoby.sort(() => 0.5 - Math.random()).slice(0, 2);
          schedule[label] = { 
            date, 
            osoby: selected.map(n => ({ name: n, klasa: row.klasa })) 
          };
        }
      }
      return schedule;
    }

    // üß± Rysowanie tabeli
    function renderTable(schedule) {
      const container = document.getElementById("result");
      container.innerHTML = "";

      const weekDays = Object.keys(schedule);
      const table = document.createElement("table");

      // nag≈Ç√≥wek
      const header = document.createElement("tr");
      for (const day of weekDays) {
        const th = document.createElement("th");
        th.innerHTML = `${day}<br><small>${schedule[day].date}</small>`;
        header.appendChild(th);
      }
      table.appendChild(header);

      // rzƒÖd 1
      const row1 = document.createElement("tr");
      for (const day of weekDays) {
        const td = document.createElement("td");
        const osoby = schedule[day].osoby;
        td.textContent = osoby[0] ? `${osoby[0].name}, ${osoby[0].klasa}` : "";
        row1.appendChild(td);
      }
      table.appendChild(row1);

      // rzƒÖd 2
      const row2 = document.createElement("tr");
      for (const day of weekDays) {
        const td = document.createElement("td");
        const osoby = schedule[day].osoby;
        td.textContent = osoby[1] ? `${osoby[1].name}, ${osoby[1].klasa}` : "";
        row2.appendChild(td);
      }
      table.appendChild(row2);

      container.appendChild(table);
    }

    // üîÅ Generowanie nowego harmonogramu
    function regenerate() {
      const schedule = generateSchedule(entries);
      renderTable(schedule);
    }

    // üíæ Zapis jako PNG
    async function saveAsImage() {
      const node = document.getElementById("result");
      const canvas = await html2canvas(node, { scale: 2 });
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "harmonogram_radiowezel.png";
      a.click();
    }

    // üöÄ Start
    async function main() {
      const result = document.getElementById("result");
      const saveBtn = document.getElementById("saveBtn");
      const regenBtn = document.getElementById("regenBtn");

      try {
        const rows = await loadSheetData();
        entries = parsePeople(rows);
        regenerate();
        saveBtn.disabled = false;
        regenBtn.disabled = false;
      } catch (e) {
        console.error(e);
        result.innerHTML = `<p class="text-danger">${e.message}</p>`;
      }
    }

    document.getElementById("regenBtn").addEventListener("click", regenerate);
    document.getElementById("saveBtn").addEventListener("click", saveAsImage);

    main();
  </script>
</body>
</html>
