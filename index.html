<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Harmonogram RadiowÄ™zÅ‚a</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background:lightgrey; padding: 20px; }
    .table-card { 
      background:white; padding:20px; border-radius:12px; 
      box-shadow:0 4px 16px rgba(0,0,0,0.1); 
      max-width:900px; margin:40px auto;
    }
    table { width:100%; border-collapse:collapse; text-align:center; }
    th, td { border:1px solid #ccc; padding:10px; vertical-align:middle; }
    th { background:#8865AD; color:white; font-weight:bold; }
    th.editable { cursor: pointer; position: relative; }
    th.editable:hover { background:#7554a0; }
    .edit-icon { 
      font-size: 14px;
      margin-left: 5px;
    }
    button { margin:10px; }
    .person-option {
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .person-option:hover {
      background: #f0f0f0;
    }
    .person-option.selected {
      background: #8865AD;
      color: white;
      border-color: #8865AD;
    }
    .person-name {
      font-weight: bold;
    }
    .person-class {
      font-size: 0.9em;
      color: #666;
    }
    .person-option.selected .person-class {
      color: #eee;
    }
  </style>
</head>
<body>
  <div class="text-center">
    <h1>Harmonogram RadiowÄ™zÅ‚a</h1>
  </div>

  <div id="result" class="table-card text-center">
    <p class="text-muted">Trwa Å‚adowanie danych z arkusza...</p>
  </div>

  <div class="text-center">
    <button id="regenBtn" class="btn btn-primary" disabled>ðŸŽ² Generuj ponownie</button>
    <button id="saveBtn" class="btn btn-success" disabled>ðŸ’¾ Zapisz jako PNG</button>
  </div>

  <!-- Modal do edycji dnia -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edytuj dyÅ¼ur: <span id="modalDayName"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Wybierz maksymalnie 2 osoby z listy:</p>
          <div id="peopleList"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Zapisz zmiany</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_KEY = "AIzaSyCVidQq2T5RZzSXFlrJ9QUOXo3_TduwcCg";
    const SPREADSHEET_ID = "1r-wkjITbyEBckGnXN1rzr4_MI-8U3PwiSoh8gntTi1k";
    const RANGE = "A:B";

    const DAYS = ["PoniedziaÅ‚ek", "Wtorek", "Åšroda", "Czwartek", "PiÄ…tek"];
    let entries = [];
    let currentSchedule = {};
    let editingDay = null;
    let modal = null;
    let selectedPeople = [];

    function getNextMonday() {
      const now = new Date();
      const day = now.getDay();
      const diff = (day === 0 ? 1 : 8 - day);
      const monday = new Date(now);
      monday.setDate(now.getDate() + diff);
      return monday;
    }

    function getWeekDates() {
      const monday = getNextMonday();
      const days = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        const formatted = d.toLocaleDateString("pl-PL", { day: "2-digit", month: "2-digit" });
        days.push({ label: DAYS[i], date: formatted });
      }
      return days;
    }

    async function loadSheetData() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Nie udaÅ‚o siÄ™ pobraÄ‡ danych z Google Sheets.");
      const data = await res.json();
      return data.values || [];
    }

    function parsePeople(rows) {
      const data = rows.slice(1);
      const parsed = [];
      for (const [klasa, osobyRaw] of data) {
        if (!klasa && !osobyRaw) continue;
        const names = (osobyRaw || "")
          .split(/[,;]+/)
          .map(x => x.trim())
          .filter(Boolean);
        if (names.length > 0) parsed.push({ klasa: klasa.trim(), osoby: names });
      }
      return parsed;
    }

    function getAllPeople() {
      const allPeople = [];
      for (const entry of entries) {
        for (const name of entry.osoby) {
          allPeople.push({ name, klasa: entry.klasa });
        }
      }
      return allPeople;
    }

    function generateSchedule(entries) {
      const available = [...entries];
      const weekDays = getWeekDates();
      const schedule = {};

      for (const { label, date } of weekDays) {
        if (available.length === 0) {
          schedule[label] = { date, osoby: [] };
          continue;
        }

        const idx = Math.floor(Math.random() * available.length);
        const row = available.splice(idx, 1)[0];
        let osoby = row.osoby;

        if (osoby.length === 1) {
          schedule[label] = { date, osoby: [{ name: osoby[0], klasa: row.klasa }] };
        } else {
          const selected = osoby.sort(() => 0.5 - Math.random()).slice(0, 2);
          schedule[label] = { 
            date, 
            osoby: selected.map(n => ({ name: n, klasa: row.klasa })) 
          };
        }
      }
      return schedule;
    }

    function renderTable(schedule) {
      const container = document.getElementById("result");
      container.innerHTML = "";

      const weekDays = Object.keys(schedule);
      const table = document.createElement("table");

      const header = document.createElement("tr");
      for (const day of weekDays) {
        const th = document.createElement("th");
        th.className = "editable";
        th.innerHTML = `${day}<br><small>${schedule[day].date}</small><span class="edit-icon"> </span>`;
        th.onclick = () => openEditModal(day);
        header.appendChild(th);
      }
      table.appendChild(header);

      const row1 = document.createElement("tr");
      for (const day of weekDays) {
        const td = document.createElement("td");
        const osoby = schedule[day].osoby;
        td.textContent = osoby[0] ? `${osoby[0].name}, ${osoby[0].klasa}` : "";
        row1.appendChild(td);
      }
      table.appendChild(row1);

      const row2 = document.createElement("tr");
      for (const day of weekDays) {
        const td = document.createElement("td");
        const osoby = schedule[day].osoby;
        td.textContent = osoby[1] ? `${osoby[1].name}, ${osoby[1].klasa}` : "";
        row2.appendChild(td);
      }
      table.appendChild(row2);

      container.appendChild(table);
    }

    function openEditModal(day) {
      editingDay = day;
      selectedPeople = [...currentSchedule[day].osoby].filter(p => p);
      
      document.getElementById("modalDayName").textContent = `${day} (${currentSchedule[day].date})`;
      
      const peopleList = document.getElementById("peopleList");
      peopleList.innerHTML = "";
      
      const allPeople = getAllPeople();
      
      allPeople.forEach((person, idx) => {
        const div = document.createElement("div");
        div.className = "person-option";
        div.innerHTML = `
          <div class="person-name">${person.name}</div>
          <div class="person-class">${person.klasa}</div>
        `;
        
        const isSelected = selectedPeople.some(p => p.name === person.name && p.klasa === person.klasa);
        if (isSelected) {
          div.classList.add("selected");
        }
        
        div.onclick = () => togglePerson(div, person);
        peopleList.appendChild(div);
      });
      
      modal.show();
    }

    function togglePerson(element, person) {
      const isSelected = element.classList.contains("selected");
      
      if (isSelected) {
        element.classList.remove("selected");
        selectedPeople = selectedPeople.filter(p => !(p.name === person.name && p.klasa === person.klasa));
      } else {
        if (selectedPeople.length < 2) {
          element.classList.add("selected");
          selectedPeople.push(person);
        } else {
          alert("MoÅ¼esz wybraÄ‡ maksymalnie 2 osoby na jeden dzieÅ„.");
        }
      }
    }

    function saveEdit() {
      currentSchedule[editingDay].osoby = [...selectedPeople];
      renderTable(currentSchedule);
      modal.hide();
    }

    function regenerate() {
      currentSchedule = generateSchedule(entries);
      renderTable(currentSchedule);
    }

    async function saveAsImage() {
      const node = document.getElementById("result");
      const canvas = await html2canvas(node, { scale: 2 });
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "harmonogram_radiowezel.png";
      a.click();
    }

    async function main() {
      const result = document.getElementById("result");
      const saveBtn = document.getElementById("saveBtn");
      const regenBtn = document.getElementById("regenBtn");

      modal = new bootstrap.Modal(document.getElementById('editModal'));
      
      document.getElementById("saveEditBtn").addEventListener("click", saveEdit);

      try {
        const rows = await loadSheetData();
        entries = parsePeople(rows);
        regenerate();
        saveBtn.disabled = false;
        regenBtn.disabled = false;
      } catch (e) {
        console.error(e);
        result.innerHTML = `<p class="text-danger">${e.message}</p>`;
      }
    }

    document.getElementById("regenBtn").addEventListener("click", regenerate);
    document.getElementById("saveBtn").addEventListener("click", saveAsImage);

    main();
  </script>
</body>

</html>
